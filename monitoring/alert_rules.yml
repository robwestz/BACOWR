# Prometheus Alert Rules for BACOWR

groups:
  - name: bacowr_api_alerts
    interval: 30s
    rules:
      # High error rate alert
      - alert: HighAPIErrorRate
        expr: |
          (
            rate(api_requests_total{status=~"5.."}[5m])
            /
            rate(api_requests_total[5m])
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "High API error rate detected"
          description: "API error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

      # High response time alert
      - alert: HighAPILatency
        expr: |
          histogram_quantile(0.95,
            rate(api_request_duration_seconds_bucket[5m])
          ) > 2.0
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "High API latency detected"
          description: "API p95 latency is {{ $value }}s (threshold: 2s)"

      # Many blocked jobs alert
      - alert: HighQCBlockRate
        expr: |
          (
            increase(jobs_completed_total{status="blocked"}[1h])
            /
            increase(jobs_completed_total[1h])
          ) > 0.15
        for: 30m
        labels:
          severity: warning
          component: qc
        annotations:
          summary: "High QC block rate"
          description: "{{ $value | humanizePercentage }} of jobs are being blocked by QC (threshold: 15%)"

      # High LLM costs alert
      - alert: HighLLMCosts
        expr: rate(llm_generation_cost_dollars[1h]) > 10
        for: 15m
        labels:
          severity: warning
          component: llm
        annotations:
          summary: "High LLM costs detected"
          description: "LLM costs are ${{ $value }}/hour (threshold: $10/hour)"

  - name: bacowr_system_alerts
    interval: 30s
    rules:
      # API is down
      - alert: APIDown
        expr: up{job="bacowr-api"} == 0
        for: 2m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "BACOWR API is down"
          description: "API has been unavailable for more than 2 minutes"

      # Too many active jobs
      - alert: TooManyActiveJobs
        expr: active_jobs > 100
        for: 10m
        labels:
          severity: warning
          component: orchestrator
        annotations:
          summary: "Too many active jobs"
          description: "{{ $value }} jobs are active (threshold: 100). Possible stuck jobs?"
