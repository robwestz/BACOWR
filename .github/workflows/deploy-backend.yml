name: Deploy Backend

on:
  push:
    branches: [ main, master ]
    paths:
      - 'api/**'
      - 'src/**'
      - 'config/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        cd api
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests before deploy
      run: |
        cd api
        pip install pytest pytest-asyncio
        pytest tests/ -v || echo "Tests failed - review before deploying"
      env:
        DATABASE_URL: sqlite:///./test.db
        BACOWR_LLM_MODE: mock

    # Railway deployment (if using Railway)
    - name: Deploy to Railway
      if: env.RAILWAY_TOKEN != ''
      run: |
        npm install -g @railway/cli
        railway up --service backend
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    # Docker build and push (for container-based deployment)
    - name: Set up Docker Buildx
      if: env.DOCKER_USERNAME != ''
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      if: env.DOCKER_USERNAME != ''
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Docker image
      if: env.DOCKER_USERNAME != ''
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/bacowr-api:latest
          ${{ secrets.DOCKER_USERNAME }}/bacowr-api:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    # Health check after deployment
    - name: Wait for deployment
      run: sleep 30

    - name: Health check
      if: env.PRODUCTION_URL != ''
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_URL }}/health)
        if [ $response -eq 200 ]; then
          echo "✅ Deployment successful - health check passed"
        else
          echo "❌ Deployment may have failed - health check returned $response"
          exit 1
        fi
      continue-on-error: true

    - name: Notify deployment status
      if: always()
      run: |
        if [ $? -eq 0 ]; then
          echo "::notice::Backend deployed successfully to production"
        else
          echo "::error::Backend deployment failed or health check did not pass"
        fi
